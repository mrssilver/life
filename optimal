------------lisp----------------
(defun read-lisp-file (filename)
  "é«˜æ•ˆè¯»å– Lisp æ–‡ä»¶å¹¶è¿”å›å†…å®¹å­—ç¬¦ä¸²ã€‚"
  (with-temp-buffer
    (insert-file-contents-literally filename)
    (buffer-string)))

(defun tokenize-lisp (lisp-code)
  "ä½¿ç”¨çŠ¶æ€æœºé«˜æ•ˆåœ°å°† Lisp ä»£ç è½¬æ¢ä¸º tokensã€‚"
  (let ((tokens '())
        (in-string nil)
        (in-comment nil)
        (escape-next nil)
        (current-token "")
        (i 0)
        (len (length lisp-code)))
    
    (cl-loop while (< i len) do
             (let ((char (aref lisp-code i)))
               (cond
                (in-comment
                 (when (eq char ?\n)
                   (setq in-comment nil)))
                
                (in-string
                 (cond
                  (escape-next
                   (setq current-token (concat current-token (string char)))
                   (setq escape-next nil))
                  ((eq char ?\\)
                   (setq escape-next t)
                   (setq current-token (concat current-token (string char))))
                  ((eq char ?\")
                   (setq current-token (concat current-token (string char)))
                   (push current-token tokens)
                   (setq current-token "")
                   (setq in-string nil))
                  (t
                   (setq current-token (concat current-token (string char))))))
                
                (t
                 (cond
                  ((eq char ?\;)
                   (setq in-comment t))
                  ((eq char ?\")
                   (unless (string-empty-p current-token)
                     (push current-token tokens)
                     (setq current-token ""))
                   (setq in-string t)
                   (setq current-token (string char)))
                  ((memq char '(?\( ?\)))
                   (unless (string-empty-p current-token)
                     (push current-token tokens)
                     (setq current-token ""))
                   (push (string char) tokens))
                  ((memq char '(?\s ?\t ?\n ?\r))
                   (unless (string-empty-p current-token)
                     (push current-token tokens)
                     (setq current-token "")))
                  (t
                   (setq current-token (concat current-token (string char)))))))
             
             (setq i (1+ i)))
    
    (unless (string-empty-p current-token)
      (push current-token tokens))
    
    (nreverse tokens)))

(defun number-string-p (str)
  "ä¸¥æ ¼æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦å¯ä»¥è½¬æ¢ä¸ºæ•°å­—ã€‚"
  (and (stringp str)
       (not (string-empty-p str))
       (string-match-p "\\`-?\\(?:[0-9]+\\.?[0-9]*\\|\\.[0-9]+\\)\\(?:[eE][-+]?[0-9]+\\)?\\'" str)
       (not (string-match-p "\\`0[0-9]" str))))

(defun parse-lisp-expression (tokens)
  "é«˜æ•ˆè§£æ tokens ä¸ºå¤šå‰æ ‘ç»“æ„ã€‚"
  (let ((tree '())
        (stack '())
        (current-node nil))
    
    (dolist (token tokens)
      (cond
       ((string= token "(")
        (push current-node stack)
        (setq current-node (list :type "list" :children '())))
       
       ((string= token ")")
        (if-let ((parent (pop stack)))
            (progn
              (setf (plist-get parent :children) 
                    (nconc (plist-get parent :children) (list current-node)))
              (setq current-node parent))
          (push current-node tree)
          (setq current-node nil)))
       
       (t
        (let* ((node-type "symbol")
               (value token)
               (first-char (aref token 0))
               (last-char (aref token (1- (length token)))))
          
          (cond
           ((number-string-p token)
            (setq node-type "number")
            (setq value (string-to-number token)))
           
           ((and (>= (length token) 2)
                 (eq first-char ?\")
                 (eq last-char ?\"))
            (setq node-type "string")
            (setq value (substring token 1 -1)))
           
           ((string= token "t")
            (setq node-type "boolean")
            (setq value t))
           
           ((string= token "nil")
            (setq node-type "boolean")
            (setq value nil)))
          
          (let ((node (list :type node-type :value value)))
            (if current-node
                (setf (plist-get current-node :children)
                      (nconc (plist-get current-node :children) (list node)))
              (push node tree)))))))
    
    (when current-node
      (push current-node tree))
    
    (nreverse tree)))

(defun insert-tree-pretty (node &optional prefix is-last depth)
  "ä»¥ç¾è§‚çš„æ ‘å½¢æ ¼å¼æ’å…¥ç»“æ„åˆ°å½“å‰ç¼“å†²åŒºã€‚"
  (unless depth (setq depth 0))
  (unless prefix (setq prefix ""))
  
  (let ((node-prefix (if is-last
                         (concat prefix "â””â”€â”€ ")
                       (concat prefix "â”œâ”€â”€ "))))
    
    (if (string= (plist-get node :type) "list")
        (progn
          (insert (format "%s[list]\n" node-prefix))
          (let ((child-prefix (if is-last
                                  (concat prefix "    ")
                                (concat prefix "â”‚   ")))
                (children (plist-get node :children)))
            (cl-loop for child in children
                     for i from 0
                     do (insert-tree-pretty child child-prefix 
                                           (= i (1- (length children))) 
                                           (1+ depth)))))
      
      (let ((value (plist-get node :value))
            (type (plist-get node :type)))
        (insert (format "%s%s: %s\n" node-prefix type
                        (cond
                         ((string= type "string") (format "\"%s\"" value))
                         ((string= type "boolean") (if value "t" "nil"))
                         (t (format "%s" value)))))))))

(defun json-escape-string (str)
  "è½¬ä¹‰å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦ä»¥ç”¨äºJSONã€‚"
  (replace-regexp-in-string
   "\"" "\\\\\""
   (replace-regexp-in-string
    "\\\\" "\\\\\\\\"
    (replace-regexp-in-string
     "\n" "\\\\n"
     (replace-regexp-in-string
      "\r" "\\\\r"
      (replace-regexp-in-string
       "\t" "\\\\t" str))))))

(defun tree-to-json (node)
  "é«˜æ•ˆå°†æ ‘ç»“æ„è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚"
  (if (string= (plist-get node :type) "list")
      (let ((children-json 
             (mapconcat #'tree-to-json (plist-get node :children) ",")))
        (format "{\"type\":\"list\",\"children\":[%s]}" children-json))
    
    (let ((type (plist-get node :type))
          (value (plist-get node :value)))
      (format "{\"type\":\"%s\",\"value\":%s}" type
              (cond
               ((string= type "string") 
                (format "\"%s\"" (json-escape-string value)))
               ((string= type "boolean") (if value "true" "false"))
               (t (format "%s" value)))))))

(defun process-lisp-file-to-tree-json (filename)
  "å¤„ç†æŒ‡å®šçš„ Lisp æ–‡ä»¶å¹¶å°†ç»“æœæ’å…¥åˆ° *tree-json* ç¼“å†²åŒºã€‚"
  (let ((content (read-lisp-file filename))
        (tokens (tokenize-lisp (read-lisp-file filename)))
        (tree (parse-lisp-expression tokens)))
    
    (with-current-buffer (get-buffer-create "*tree-json*")
      (erase-buffer)
      (lisp-tree-viewer-mode)
      (insert (format "Parsing Lisp file: %s\n\n" filename))
      (insert "Multi-way tree structure:\n")
      (insert "=========================\n")
      
      (dolist (node tree)
        (insert-tree-pretty node)
        (insert "\n"))
      
      ;; æ·»åŠ åˆ†éš”ç©ºè¡Œ
      (insert "\n\n")
      
      (insert "JSON representation:\n")
      (insert "====================\n")
      
      (if (= (length tree) 1)
          (insert (format "%s\n" (tree-to-json (car tree))))
        (let ((root (list :type "list" :children tree)))
          (insert (format "%s\n" (tree-to-json root)))))
      
      (goto-char (point-min))
      (display-buffer (current-buffer)))))

;;; äº¤äº’å‘½ä»¤
(defun lisp-tree-viewer ()
  "äº¤äº’å¼é€‰æ‹© Lisp æ–‡ä»¶å¹¶åœ¨ *tree-json* ç¼“å†²åŒºä¸­æ˜¾ç¤ºæ ‘ç»“æ„ã€‚"
  (interactive)
  (let ((filename (read-file-name "Select Lisp file: " nil nil t)))
    (process-lisp-file-to-tree-json filename)))

(defun lisp-tree-viewer-eval (expr)
  "è¯„ä¼° Lisp è¡¨è¾¾å¼å¹¶åœ¨ *tree-json* ç¼“å†²åŒºä¸­æ˜¾ç¤ºæ ‘ç»“æ„ã€‚"
  (interactive "sEnter Lisp expression: ")
  (let ((tokens (tokenize-lisp expr))
        (tree (parse-lisp-expression tokens)))
    
    (with-current-buffer (get-buffer-create "*tree-json*")
      (erase-buffer)
      (lisp-tree-viewer-mode)
      (insert (format "Evaluating expression: %s\n\n" expr))
      (insert "Multi-way tree structure:\n")
      (insert "=========================\n")
      
      (dolist (node tree)
        (insert-tree-pretty node)
        (insert "\n"))
      
      (insert "\n\n")
      
      (insert "JSON representation:\n")
      (insert "====================\n")
      
      (if (= (length tree) 1)
          (insert (format "%s\n" (tree-to-json (car tree))))
        (let ((root (list :type "list" :children tree)))
          (insert (format "%s\n" (tree-to-json root)))))
      
      (goto-char (point-min))
      (display-buffer (current-buffer)))))

;;; ä¸»è¦æ¨¡å¼å®šä¹‰
(define-derived-mode lisp-tree-viewer-mode special-mode "Lisp Tree Viewer"
  "Major mode for viewing Lisp tree structures."
  (setq truncate-lines t)
  (setq show-trailing-whitespace nil)
  (setq buffer-read-only t)
  (font-lock-mode 1))

;;; æŒ‰é”®ç»‘å®š
(defvar lisp-tree-viewer-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map (kbd "q") 'quit-window)
    (define-key map (kbd "g") 'lisp-tree-viewer)
    (define-key map (kbd "e") 'lisp-tree-viewer-eval)
    (define-key map (kbd "n") 'forward-button)
    (define-key map (kbd "p") 'backward-button)
    (define-key map (kbd "RET") 'push-button)
    map)
  "Keymap for Lisp Tree Viewer mode.")


;;;###autoload
(defun lisp-tree-viewer-file (filename)
  "æ‰“å¼€ Lisp æ–‡ä»¶å¹¶åœ¨ *tree-json* ç¼“å†²åŒºä¸­æ˜¾ç¤ºå…¶æ ‘ç»“æ„ã€‚"
  (interactive "fLisp file: ")
  (process-lisp-file-to-tree-json filename))
(provide 'lisp-tree-viewer)

------------optimal color ------
(deftheme imperial-gold "imperial theme")

;; ç®€åŒ–é¢œè‰²å®šä¹‰
(setq imperial-gold/colors
      '(("#0a0814" . dawn-dim)      ; ç„å¤œèƒŒæ™¯
        ("#c23b3b" . royal-blood)   ; å‡½æ•°/å˜é‡å®šä¹‰è¡€è‰²
        ("#e6b422" . imperial-gold) ; æ³¨é‡Šé‡‘è‰²
        ("#fffaf0" . ivory-milk)    ; æ™®é€šå­—ç¬¦ä¹³ç™½
        ("#fffff1" . cream)         ; é«˜äº®ä¹³ç™½
        ("#ffed8a" . gold-light)    ; è¾…åŠ©é‡‘è‰²
        ("#fc7f22" . crimson-shadow); è¡€è‰²é˜´å½± orange
        ("#5d3a9b" . regal-purple)  ; è£…é¥°ç´«è‰²
        ("#1f1b24" . night-sky)     ; éæ¿€æ´»æ¨¡å¼è¡ŒèƒŒæ™¯ night black
        ("#a81159" . light-red)))   ; éæ¿€æ´»æ¨¡å¼è¡Œå‰æ™¯light red

;; è¾…åŠ©å‡½æ•°ï¼šè·å–é¢œè‰²å€¼
(defun imperial-color (name)
  "æ ¹æ®åç§°è·å–é¢œè‰²å€¼"
  (car (rassoc name imperial-gold/colors)))

(custom-theme-set-faces
 'imperial-gold
 ;; == æ ¸å¿ƒè§„åˆ™ ==
 `(default ((t :background ,(imperial-color 'dawn-dim)
               :foreground ,(imperial-color 'imperial-gold))))
  
 ;; è¯­æ³•é«˜äº®
 `(font-lock-keyword-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-builtin-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-constant-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-type-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-doc-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-string-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(font-lock-warning-face ((t :foreground ,(imperial-color 'imperial-gold))))
 
 ;; ç‰¹æ®Šé«˜äº®
 `(company-tooltip-common-selection ((t :background "red" :foreground "black")))
 `(completions-common-part ((t :foreground "moccasin")))
 `(elisp-shorthand-font-lock-face ((t :inherit font-lock-keyword-face :foreground "Red1")))
 `(link ((t :foreground "dark red" :underline t)))
 `(secondary-selection ((t :extend t :background "dark red")))
 `(shadow ((t :foreground "dark red")))
 `(tab-bar ((t :inherit variable-pitch :background "dark red" :foreground "black")))
 `(tab-line ((t :inherit variable-pitch :background "dark red" :foreground "black" :height 0.9)))
 `(tool-bar ((t :background "dark red" :foreground "black" :box (:line-width (1 . 1) :style released-button))))
 
 ;; å‡½æ•°/å˜é‡å®šä¹‰å¤„ - è¡€è‰²
 `(font-lock-function-name-face ((t :foreground ,(imperial-color 'royal-blood) :bold t)))
 `(font-lock-variable-name-face ((t :foreground ,(imperial-color 'royal-blood))))
 
 ;; æ³¨é‡Š
 `(font-lock-comment-face ((t :foreground ,(imperial-color 'ivory-milk) :italic t)))
 
 ;; == å…¶ä»– UI å…ƒç´  ==
 `(line-number ((t :foreground ,(imperial-color 'light-red)
                   :background ,(imperial-color 'dawn-dim))))
 `(line-number-current-line ((t :foreground ,(imperial-color 'regal-purple)
                                :background ,(imperial-color 'crimson-shadow))))
 `(minibuffer-prompt ((t :foreground ,(imperial-color 'imperial-gold) :weight bold)))
 `(highlight ((t :background ,(imperial-color 'crimson-shadow))))
 `(match ((t :foreground ,(imperial-color 'light-red)
             :background ,(imperial-color 'gold-light))))
 `(occur-match ((t :foreground ,(imperial-color 'light-red)
                   :background ,(imperial-color 'gold-light))))
 
 ;; è‡ªå®šä¹‰ mode-line
 `(mode-line ((t :background ,(imperial-color 'regal-purple)
                 :foreground ,(imperial-color 'imperial-gold)
                 :box nil
                 :height 1.05)))
 `(mode-line-inactive ((t :background ,(imperial-color 'night-sky) 
                          :foreground ,(imperial-color 'light-red))))
 `(mode-line-buffer-face ((t :foreground ,(imperial-color 'imperial-gold) :weight bold)))
 `(mode-line-position-face ((t :foreground ,(imperial-color 'imperial-gold))))
 `(mode-line-git-face ((t :foreground ,(imperial-color 'crimson-shadow))))
 
 ;; ä»¥ä¸‹æ˜¯ä¸€äº›ç‰¹æ®Šçš„é¢éƒ¨è®¾ç½®ï¼Œç®€åŒ–å¤„ç†
 `(link-visited ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp-inlay-hint-face ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp-inlay-hint-parameter-face ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp ((t :background ,(imperial-color 'crimson-shadow))))
 `(org-footnote ((t :background ,(imperial-color 'crimson-shadow))))
 `(org-table ((t :background ,(imperial-color 'crimson-shadow))))
 `(org-table-row ((t :background ,(imperial-color 'crimson-shadow))))
 `(org-table-header ((t :background ,(imperial-color 'crimson-shadow))))
 `(org-sexp-date ((t :background ,(imperial-color 'crimson-shadow))))
 `(lazy-highlight ((t :background ,(imperial-color 'crimson-shadow))))
 `(undo-tree-visualizer-unmodified-face ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp-ui-doc-highlight-hover ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp-ui-peek-line-number ((t :background ,(imperial-color 'crimson-shadow))))
 `(region ((t :background ,(imperial-color 'crimson-shadow))))
 `(tab-bar-tab-inactive ((t :background ,(imperial-color 'crimson-shadow))))
 `(tab-bar-tab-group-inactive ((t :background ,(imperial-color 'crimson-shadow))))
 `(tab-bar-tab-ungrouped ((t :background ,(imperial-color 'crimson-shadow))))
 `(escape-glyph ((t :background ,(imperial-color 'crimson-shadow))))
 `(lsp-modeline-code-actions-face ((t :background ,(imperial-color 'crimson-shadow))))
 
 ;; æ‹¬å·åŒ¹é…
 `(show-paren-match ((t :background ,(imperial-color 'crimson-shadow)
                        :foreground ,(imperial-color 'gold-light)
                        :weight ultra-bold
                        :box (:line-width -1 :color ,(imperial-color 'royal-blood)))))
 `(show-paren-mismatch ((t :background ,(imperial-color 'royal-blood)
                           :foreground ,(imperial-color 'crimson-shadow)
                           :weight ultra-bold)))
)

;; ======================================================================
;; == é€’å½’æ‹¬å·å¯è§†åŒ–ç³»ç»Ÿ ==
;; ======================================================================
(setq imperial-gold/bracket-colors
      (list (imperial-color 'imperial-gold) ; 1. å¸ç‹é‡‘
            (imperial-color 'royal-blood)   ; 2. è¡€è‰²
            (imperial-color 'ivory-milk)    ; 3. ä¹³ç™½
            (imperial-color 'gold-light)    ; 4. äº®é‡‘
            (imperial-color 'regal-purple))) ; 5. ç´«é‡‘

(defun imperial-gold/setup-bracket-colors ()
  "åº”ç”¨å¸ç‹é‡‘ä¸»é¢˜çš„é€’å½’æ‹¬å·é…è‰²"
  (let ((depth-colors (make-vector 10 nil)))
    (dotimes (i 10)
      (setf (aref depth-colors i)
            `((t :foreground ,(nth (mod i 5) imperial-gold/bracket-colors) 
                 :weight ultra-bold))))
    
    (custom-theme-set-faces
     'imperial-gold
     ;; å°æ‹¬å·
     `(rainbow-delimiters-depth-1-face ,(aref depth-colors 0))
     `(rainbow-delimiters-depth-2-face ,(aref depth-colors 1))
     `(rainbow-delimiters-depth-3-face ,(aref depth-colors 2))
     `(rainbow-delimiters-depth-4-face ,(aref depth-colors 3))
     `(rainbow-delimiters-depth-5-face ,(aref depth-colors 4))
     `(rainbow-delimiters-depth-6-face ,(aref depth-colors 0))
     `(rainbow-delimiters-depth-7-face ,(aref depth-colors 1))
     `(rainbow-delimiters-depth-8-face ,(aref depth-colors 2))
     `(rainbow-delimiters-depth-9-face ,(aref depth-colors 3))
     
     ;; å¤§æ‹¬å·
     `(rainbow-delimiters-depth-1-curly-face ,(aref depth-colors 1))
     `(rainbow-delimiters-depth-2-curly-face ,(aref depth-colors 2))
     `(rainbow-delimiters-depth-3-curly-face ,(aref depth-colors 3))
     `(rainbow-delimiters-depth-4-curly-face ,(aref depth-colors 4))
     `(rainbow-delimiters-depth-5-curly-face ,(aref depth-colors 0))
     `(rainbow-delimiters-depth-6-curly-face ,(aref depth-colors 1))
     `(rainbow-delimiters-depth-7-curly-face ,(aref depth-colors 2))
     `(rainbow-delimiters-depth-8-curly-face ,(aref depth-colors 3))
     `(rainbow-delimiters-depth-9-curly-face ,(aref depth-colors 4)))))

;; é…ç½®æ‹¬å·é¢œè‰²
(imperial-gold/setup-bracket-colors)

;; ======================================================================
;; == è‡ªåŠ¨å¯ç”¨é€’å½’æ‹¬å·å¯è§†åŒ– ==
;; ======================================================================
(defun imperial-gold/bracket-visualization ()
  "ä¸ºæ‰€æœ‰ç¼–ç¨‹æ¨¡å¼å¯ç”¨é€’å½’æ‹¬å·å¯è§†åŒ–"
  (require 'rainbow-delimiters)
  (rainbow-delimiters-mode t)
  (show-paren-mode t))

;; æ·»åŠ åˆ°æ‰€æœ‰ç¼–ç¨‹æ¨¡å¼çš„hook
(add-hook 'prog-mode-hook #'imperial-gold/bracket-visualization)

;; æä¾›ä¸»é¢˜
(provide-theme 'imperial-gold)
;;; imperial-mode-line.el --- Imperial theme mode-line configuration  -*- lexical-binding: t; -*-

(defgroup imperial-mode-line nil
  "Customization options for Imperial mode-line."
  :group 'mode-line)

(defcustom imperial-mode-line-show-time t
  "Whether to show time in the mode-line."
  :type 'boolean
  :group 'imperial-mode-line)

(defcustom imperial-mode-line-show-git t
  "Whether to show Git branch information in the mode-line."
  :type 'boolean
  :group 'imperial-mode-line)

(defcustom imperial-mode-line-time-format "%H:%M"
  "Format string for time display in mode-line.
See `format-time-string' for available format options."
  :type 'string
  :group 'imperial-mode-line)

;; Git åˆ†æ”¯è·å–å‡½æ•°
(defun imperial/mode-line-git-branch ()
  "Return current Git branch or empty string if not in a Git repo."
  (when (and imperial-mode-line-show-git
             (buffer-file-name)
             (file-exists-p (buffer-file-name))
             (executable-find "git"))
    (let ((default-directory (file-name-directory (buffer-file-name))))
      (with-temp-buffer
        (when (eq 0 (call-process "git" nil t nil "rev-parse" "--abbrev-ref" "HEAD"))
          (string-trim (buffer-string)))))))

;; æ–‡ä»¶ä¿®æ”¹çŠ¶æ€æŒ‡ç¤ºå™¨
(defun imperial/mode-line-buffer-status ()
  "Return a status indicator based on buffer modification state."
  (cond ((buffer-modified-p) "ğŸ”´")  ; çº¢è‰²åœ†ç‚¹è¡¨ç¤ºå·²ä¿®æ”¹
        ((buffer-read-only-p) "ğŸ”’") ; é”è¡¨ç¤ºåªè¯»
        (t "ğŸŸ¢")))                 ; ç»¿è‰²åœ†ç‚¹è¡¨ç¤ºæœªä¿®æ”¹

;; é™æ€æ—¶é—´å˜é‡ï¼ˆæ¯ä¸ªç¼“å†²åŒºç‹¬ç«‹ï¼‰
(defvar-local imperial/mode-line-static-time nil
  "Static time for each buffer, set when the buffer is first displayed.")

;; è®¾ç½®é™æ€æ—¶é—´ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºæ—¶è®¾ç½®ï¼‰
(defun imperial/mode-line-set-static-time ()
  "Set static time for current buffer if not already set."
  (when (and imperial-mode-line-show-time (not imperial/mode-line-static-time))
    (setq imperial/mode-line-static-time (format-time-string imperial-mode-line-time-format))))

;; è®¾ç½® mode-line æ ¼å¼
(defun imperial/mode-line-format ()
  "Return the mode-line format for Imperial theme."
  (list
   ;; å·¦ä¾§éƒ¨åˆ†
   '(:eval (imperial/mode-line-buffer-status))
   " "
   '(:propertize "%b" face mode-line-buffer-face) ; ç¼“å†²åŒºåç§°
   " "
   '(:propertize "(%l,%c)" face mode-line-position-face) ; è¡Œå·åˆ—å·
   " "
   '(:eval (when-let ((branch (imperial/mode-line-git-branch)))
             (concat "[" branch "]")))
   
   ;; ä¸­é—´å¡«å……ç©ºé—´
   '(:propertize " " display ((space :align-to (- right 20))))
   
   ;; å³ä¾§éƒ¨åˆ† - é™æ€æ—¶é—´
   '(:eval (when imperial-mode-line-show-time imperial/mode-line-static-time))
   ))

;; è®¾ç½® mode-line å¤–è§‚
(defun imperial/mode-line-set-faces ()
  "Set mode-line faces for Imperial theme."
  (custom-set-faces
   `(mode-line ((t :background ,(imperial-color 'regal-purple)
                   :foreground ,(imperial-color 'imperial-gold)
                   :box nil
                   :height 1.05
                   :weight bold)))
   `(mode-line-inactive ((t :background ,(imperial-color 'night-sky) 
                            :foreground ,(imperial-color 'light-red)
                            :box nil
                            :height 0.9)))
   `(mode-line-buffer-face ((t :foreground ,(imperial-color 'imperial-gold)
                               :weight bold)))
   `(mode-line-position-face ((t :foreground ,(imperial-color 'gold-light))))
   `(mode-line-highlight ((t :background ,(imperial-color 'crimson-shadow)
                             :foreground ,(imperial-color 'ivory-milk))))
   `(mode-line-emphasis ((t :weight bold
                            :foreground ,(imperial-color 'royal-blood))))))

;; ä¸»å‡½æ•°ï¼šå¯ç”¨ Imperial mode-line
(defun imperial-mode-line-enable ()
  "Enable Imperial mode-line configuration."
  (interactive)
  ;; è®¾ç½® mode-line æ ¼å¼
  (setq-default mode-line-format (imperial/mode-line-format))
  
  ;; è®¾ç½® mode-line å¤–è§‚
  (imperial/mode-line-set-faces)
  
  ;; æ·»åŠ é’©å­è®¾ç½®é™æ€æ—¶é—´
  (add-hook 'window-buffer-change-functions
            (lambda (_) (imperial/mode-line-set-static-time)))
  
  (message "Imperial mode-line enabled"))

;; ä¸»å‡½æ•°ï¼šç¦ç”¨ Imperial mode-line
(defun imperial-mode-line-disable ()
  "Disable Imperial mode-line configuration."
  (interactive)
  ;; æ¢å¤é»˜è®¤ mode-line æ ¼å¼
  (kill-local-variable 'mode-line-format)
  
  ;; ç§»é™¤é’©å­
  (remove-hook 'window-buffer-change-functions
               (lambda (_) (imperial/mode-line-set-static-time)))
  
  (message "Imperial mode-line disabled"))

;; æä¾›æ¨¡å¼
(provide 'imperial-mode-line)

;;; imperial-mode-line.el ends here

--------------ediff layout--------


	(defvar window-i nil)
(defvar window-io nil)
(defvar window-main nil)
(defvar split-window-enabled nil)
(defvar imperial-layout-count 0)
(defvar imperial-layout-pre-ediff-config nil)

;; å®šä¹‰çª—å£æ˜¾ç¤ºè§„åˆ™
(setq display-buffer-alist
      `(
        ;; Rule 1: ç³»ç»Ÿæ¶ˆæ¯ç±»ç¼“å†²åŒºï¼ˆå¤ç”¨çª—å£æ¨¡å¼ï¼‰
        (,(regexp-opt '("*Messages*" "*undo-tree*" "*Help*" "*godoc*" 
                        "*Completions*" "*compilation*" "*Occur*") 'words)
         (display-buffer-reuse-window)
         (window . ,(lambda (buffer alist)
                      (or window-i (get-window-with-purpose "I")))))

        ;; Rule 2: Goæºä»£ç æ–‡ä»¶ï¼ˆæ’é™¤ç³»ç»Ÿç›®å½•ï¼‰
        (,(concat (regexp-opt '(".go")) "\\'")
         (display-buffer-reuse-window)
         (window . ,(lambda (buffer alist)
                      (or window-i (get-window-with-purpose "I"))))
         (unless (string-match-p "/usr/" (or (buffer-file-name buffer) ""))))

        ;; Rule 3: é€šè®¯ç±»ç¼“å†²åŒºï¼ˆå›ºå®šè‡³IOçª—å£ï¼‰
        (,(regexp-opt '("*ERC*" "Buffer List*" "*mail*" "*gnus*" 
                        "*Group*" "*Summary*" "*Article*") 'words)
         (display-buffer-reuse-window)
         (window . ,(lambda (buffer alist)
                      (or window-io (get-window-with-purpose "io")))))

        ;; Rule 4: Ediff æ§åˆ¶ç¼“å†²åŒºç‰¹æ®Šå¤„ç†
        ("\\*Ediff Control\\*"
         (display-buffer-reuse-window)
         (window . ,(lambda (buffer alist)
                      (or window-i (get-window-with-purpose "I")))))
        
        ;; Rule 5: é»˜è®¤è§„åˆ™ï¼ˆä¸»çª—å£æ˜¾ç¤ºï¼‰
        (".*"  ; å…œåº•åŒ¹é…æ‰€æœ‰ç¼“å†²åŒº
         (display-buffer-same-window)
         (window . ,(lambda (buffer alist)
                      (or window-main (get-window-with-purpose "main")))))
        ))

(defun imperial-layout-on ()
  "å¯ç”¨åˆ†å±æ¨¡å¼"
  (interactive)
  (setq split-window-enabled t)
  (message "åˆ†å±å·²å¯ç”¨"))

(defun imperial-layout-off ()
  "ç¦ç”¨åˆ†å±æ¨¡å¼"
  (interactive)
  (setq split-window-enabled nil)
  (message "åˆ†å±å·²ç¦ç”¨"))

(defun imperial-layout-setup ()
  "åˆ›å»ºç¨³å®šçš„ä¸‰çª—æ ¼å¸ƒå±€ï¼ˆå·¦I/å³io+mainï¼‰"
  (interactive)
  (message "å¸ƒå±€åˆå§‹åŒ–ç¬¬ %d æ¬¡" (setq imperial-layout-count (1+ imperial-layout-count))))
  
  (imperial-layout-on)
  (delete-other-windows)

  ;; åˆ›å»ºå·¦ä¾§Içª—å£ (å®½åº¦70åˆ—)
  (setq window-i (split-window-horizontally 70))
  (set-window-parameter window-i 'window-purpose "I")

  ;; åˆ›å»ºå³ä¾§ä¸Šä¸‹åˆ†å‰²
  (setq window-io (split-window-vertically))
  (set-window-parameter window-io 'window-purpose "io")
  
  (setq window-main (next-window))
  (set-window-parameter window-main 'window-purpose "main")
  
  ;; è®¾ç½®é»˜è®¤ç¼“å†²åŒº
  (with-selected-window window-i (switch-to-buffer "*Completions*"))
  (with-selected-window window-io (switch-to-buffer "*erc*"))
  (with-selected-window window-main (switch-to-buffer "*scratch*"))
  
  (imperial-layout-off))

(defun get-window-with-purpose (purpose)
  "æŸ¥æ‰¾æŒ‡å®šç”¨é€”çš„çª—å£"
  (cl-find-if
   (lambda (w) (equal (window-parameter w 'window-purpose) purpose))
   (window-list)))

(defun imperial-layout-ensure ()
  "ç¡®ä¿ä¸‰çª—æ ¼å¸ƒå±€å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º"
  (unless (and (window-live-p window-i)
               (window-live-p window-io)
               (window-live-p window-main))
    (imperial-layout-setup)
    (message "Imperialå¸ƒå±€å·²åˆ›å»º")))

;; Ediff ç›¸å…³å‡½æ•°
(defun imperial-layout-before-ediff ()
  "Ediff å‰çš„å‡†å¤‡å·¥ä½œ"
  (imperial-layout-ensure)
  (setq imperial-layout-pre-ediff-config (current-window-configuration))
  
  ;; ç¡®ä¿çª—å£ç”¨é€”æ­£ç¡®
  (set-window-parameter window-i 'window-purpose "I")
  (set-window-parameter window-io 'window-purpose "io")
  (set-window-parameter window-main 'window-purpose "main")
  
  ;; è®¾ç½® ediff çª—å£æ‹†åˆ†å‡½æ•°ä»¥ä½¿ç”¨æˆ‘ä»¬çš„å¸ƒå±€
  (setq ediff-split-window-function 'imperial-layout-ediff-split-window)
  (setq ediff-window-setup-function 'imperial-layout-ediff-setup))

(defun imperial-layout-after-ediff ()
  "Ediff åçš„æ¸…ç†å·¥ä½œ"
  (when imperial-layout-pre-ediff-config
    (set-window-configuration imperial-layout-pre-ediff-config)
    (setq imperial-layout-pre-ediff-config nil)))

(defun imperial-layout-ediff-split-window (&optional window)
  "è‡ªå®šä¹‰ ediff çª—å£åˆ†å‰²å‡½æ•°"
  (or window (setq window (selected-window)))
  (if (and (window-live-p window-io) (window-live-p window-main))
      (list window-io window-main)
    (split-window window (/ (window-height window) 2))))

(defun imperial-layout-ediff-setup ()
  "è‡ªå®šä¹‰ ediff çª—å£è®¾ç½®"
  (imperial-layout-ensure)
  (let ((control-frame (ediff-get-visible-buffer-window "*Ediff Control*")))
    (if control-frame
        (select-window control-frame)
      (select-window window-i))
    
    (ediff-setup-windows 
     (ediff-get-buffer ediff-buffer-A)
     (ediff-get-buffer ediff-buffer-B)
     (ediff-get-buffer ediff-buffer-C)
     ediff-window-setup-function)))

;; æ·»åŠ  ediff é’©å­
(add-hook 'ediff-before-setup-hook #'imperial-layout-before-ediff)
(add-hook 'ediff-quit-hook #'imperial-layout-after-ediff)
(add-hook 'ediff-suspend-hook #'imperial-layout-after-ediff)

;; çª—å£åˆ†å‰²æ‹¦æˆªå‡½æ•°
(defun imperial-layout-split-wrapper (orig-fun &rest args)
  "æ ¹æ® split-window-enabled å†³å®šæ˜¯å¦å…è®¸åˆ†å±"
  (if split-window-enabled
      (apply orig-fun args)
    (ding)
    nil))

;; åº”ç”¨æ‹¦æˆªå»ºè®®
(dolist (func '(split-window split-window-horizontally 
               split-window-vertically split-window-sensibly))
  (advice-add func :around #'imperial-layout-split-wrapper))

;; å¯åŠ¨æ—¶ç¡®ä¿å¸ƒå±€å­˜åœ¨
(add-hook 'after-init-hook #'imperial-layout-ensure)

(provide 'imperial-layout)
-------------------------------
(defun insert-multiway-tree (tree &optional indent-last indent-str)
  "åœ¨å½“å‰ç¼“å†²åŒºæ’å…¥å¤šå‰æ ‘ç»“æ„ï¼Œä½¿ç”¨æ–‡æœ¬ç¬¦å·åˆ›å»ºæ ‘å½¢è§†å›¾ã€‚

å‚æ•°:
TREE: è¦æ’å…¥çš„å¤šå‰æ ‘ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
INDENT-LAST: å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºåˆ†æ”¯ä¸­æœ€åä¸€ä¸ªï¼ˆå†…éƒ¨é€’å½’ä½¿ç”¨ï¼‰
INDENT-STR: ç¼©è¿›å­—ç¬¦ä¸²ï¼ˆå†…éƒ¨é€’å½’ä½¿ç”¨ï¼‰

ç¤ºä¾‹:
(insert-multiway-tree '(A (B C) D))"
  (unless (or (listp tree) (stringp tree) (symbolp tree))
    (error "æ— æ•ˆçš„æ ‘ç»“æ„: %s" tree))
  
  (let* ((is-top (not indent-str))
         (prefix (cond (is-top "")     ; é¡¶çº§èŠ‚ç‚¹
                      (indent-last "â””â”€ ") ; åˆ†æ”¯æœ€åä¸€ä¸ªèŠ‚ç‚¹
                      (t "â”œâ”€ ")))     ; åˆ†æ”¯ä¸­é—´èŠ‚ç‚¹
         (current-indent (or indent-str ""))
         (children-indent (cond (is-top "") 
                               (indent-last "    ")
                               (t "â”‚   "))))
    
    ;; æ’å…¥å½“å‰èŠ‚ç‚¹
    (insert current-indent)
    (insert prefix)
    (if (listp tree)
        (insert (format "%s" (or (car tree) "â€¢")))  ; ç©ºèŠ‚ç‚¹æ˜¾ç¤ºâ€¢
      (insert (format "%s" tree)))
    (insert "\n")
    
    ;; é€’å½’å¤„ç†å­èŠ‚ç‚¹
    (when (and (listp tree) (cdr tree))
      (let* ((children (cdr tree))
             (last-idx (1- (length children))))
        (dotimes (i (length children))
          (let* ((child (nth i children))
                 (is-last (= i last-idx))
                 (new-indent (concat current-indent children-indent)))
            (insert-multiway-tree child is-last new-indent)))))))

(defun display-multiway-tree (tree &optional buffer-name)
  "åœ¨ä¸“ç”¨ç¼“å†²åŒºä¸­æ˜¾ç¤ºå¤šå‰æ ‘ç»“æ„ã€‚

å‚æ•°:
TREE: è¦æ˜¾ç¤ºçš„å¤šå‰æ ‘
BUFFER-NAME: ç¼“å†²åŒºåç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º\"*Tree View*\"ï¼‰

ç¤ºä¾‹:
(display-multiway-tree '(A (B C) D) \"æˆ‘çš„æ ‘\")"
  (setq buffer-name (or buffer-name "*Tree View*"))
  (let ((buffer (get-buffer-create buffer-name)))
    (with-current-buffer buffer
      (erase-buffer)
      (insert-multiway-tree tree)
      (special-mode)  ; ä½¿ç”¨ç‰¹æ®Šæ¨¡å¼é¿å…ç¼–è¾‘
      (view-mode-enter nil 'kill-buffer)) ; è¿›å…¥æŸ¥çœ‹æ¨¡å¼ï¼Œé€€å‡ºæ—¶å…³é—­ç¼“å†²åŒº
    (display-buffer buffer)))

;; å®šä¹‰æ ‘æ˜¾ç¤ºç¬¦å·ï¼ˆå¯ä¾›è‡ªå®šä¹‰ï¼‰
(defvar tree-display-symbols
  '((:middle . "â”œâ”€ ")    ; åˆ†æ”¯ä¸­é—´èŠ‚ç‚¹
    (:last   . "â””â”€ ")    ; åˆ†æ”¯æœ«å°¾èŠ‚ç‚¹
    (:vertical . "â”‚  ")  ; å‚ç›´çº¿
    (:space   . "   ")   ; ç©ºæ ¼ç¼©è¿›
    (:null    . "â€¢"))    ; ç©ºèŠ‚ç‚¹æ˜¾ç¤ºç¬¦å·
  "æ ‘ç»“æ„æ˜¾ç¤ºç¬¦å·å®šä¹‰")

;; ç¤ºä¾‹æ ‘ç»“æ„
(defvar multiway-tree-example
  '(A 
    "Leaf Node"
    (B 
     (C 
      "Leaf C1" 
      "Leaf C2")
     (D 
      (E "Leaf E")))
    (F 
     (G 
      (H "Leaf H1" "Leaf H2")
      (I "Leaf I")))))

;; å¤æ‚æ ‘ç»“æ„ç¤ºä¾‹
(defvar company-structure
  '(ç»„ç»‡æ¶æ„
    ("æ€»ç»ç†"
     ("æŠ€æœ¯éƒ¨"
      ("å¼€å‘ç»„" "å‰ç«¯å°ç»„" "åç«¯å°ç»„")
      ("æµ‹è¯•ç»„" "è‡ªåŠ¨åŒ–æµ‹è¯•" "æ‰‹åŠ¨æµ‹è¯•"))
     ("å¸‚åœºéƒ¨"
      ("å“ç‰Œç»„" ("ç¤¾äº¤åª’ä½“" "ä¼ ç»Ÿåª’ä½“"))
      ("é”€å”®ç»„" "çº¿ä¸Šé”€å”®" "çº¿ä¸‹é”€å”®")))
    ("è´¢åŠ¡éƒ¨" "ä¼šè®¡ç»„" "å®¡è®¡ç»„")))

;; ç›®å½•ç»“æ„ç¤ºä¾‹
(defvar document-structure
  '(æ–‡æ¡£åº“
    (æŠ€æœ¯æ–‡æ¡£
     ("APIå‚è€ƒ" "ç«¯ç‚¹1" "ç«¯ç‚¹2" "ç«¯ç‚¹3")
     ("è®¾è®¡æŒ‡å—" "UIè§„èŒƒ" "æ¶æ„å›¾"))
    (å•†ä¸šæ–‡æ¡£
     ("å¹´åº¦æŠ¥å‘Š" "2023" "2024")
     ("å¸‚åœºåˆ†æ" "ç«äº‰åˆ†æ" "ç”¨æˆ·ç”»åƒ"))))

;; åœ¨å½“å‰ç¼“å†²åŒºæ’å…¥æ ‘çš„å‡½æ•°
(defun insert-tree-here (tree)
  "åœ¨å½“å‰å…‰æ ‡ä½ç½®æ’å…¥æ ‘ç»“æ„ã€‚

æç¤ºç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ ‘ç»“æ„ï¼Œç„¶ååœ¨å½“å‰å…‰æ ‡ä½ç½®æ’å…¥è¯¥æ ‘çš„å›¾å½¢è¡¨ç¤ºã€‚"
  (interactive "XTree: ")
  (insert-multiway-tree tree))

;; æä¾›æ¨¡å¼
(provide 'multiway-tree-display)
----------------test--------------
;;; multiway-tree-display.el ends here
æµ‹è¯•1-åŸºæœ¬æ ‘:
A
â”œâ”€ Leaf Node
â”œâ”€ B
â”‚  â”œâ”€ C
â”‚  â”‚  â”œâ”€ Leaf C1
â”‚  â”‚  â””â”€ Leaf C2
â”‚  â””â”€ D
â”‚     â””â”€ E
â”‚        â””â”€ Leaf E
â””â”€ F
   â””â”€ G
      â”œâ”€ H
      â”‚  â”œâ”€ Leaf H1
      â”‚  â””â”€ Leaf H2
      â””â”€ I
         â””â”€ Leaf I

æµ‹è¯•2-å…¬å¸ç»“æ„:
ç»„ç»‡æ¶æ„
â”œâ”€ æ€»ç»ç†
â”‚  â”œâ”€ æŠ€æœ¯éƒ¨
â”‚  â”‚  â”œâ”€ å¼€å‘ç»„
â”‚  â”‚  â”‚  â”œâ”€ å‰ç«¯å°ç»„
â”‚  â”‚  â”‚  â””â”€ åç«¯å°ç»„
â”‚  â”‚  â””â”€ æµ‹è¯•ç»„
â”‚  â”‚     â”œâ”€ è‡ªåŠ¨åŒ–æµ‹è¯•
â”‚  â”‚     â””â”€ æ‰‹åŠ¨æµ‹è¯•
â”‚  â””â”€ å¸‚åœºéƒ¨
â”‚     â”œâ”€ å“ç‰Œç»„
â”‚     â”‚  â””â”€ ç¤¾äº¤åª’ä½“
â”‚     â”‚     â””â”€ ä¼ ç»Ÿåª’ä½“
â”‚     â””â”€ é”€å”®ç»„
â”‚        â”œâ”€ çº¿ä¸Šé”€å”®
â”‚        â””â”€ çº¿ä¸‹é”€å”®
â””â”€ è´¢åŠ¡éƒ¨
   â”œâ”€ ä¼šè®¡ç»„
   â””â”€ å®¡è®¡ç»„

æµ‹è¯•6-è‡ªå®šä¹‰ç¬¦å·:
A
|-> Leaf Node
|-> B
|  |-> C
|  |  |-> Leaf C1
|  |  `-> Leaf C2
|  `-> D
|     `-> E
|        `-> Leaf E
`-> F
   `-> G
      |-> H
      |  |-> Leaf H1
      |  `-> Leaf H2
      `-> I
         `-> Leaf I
